allowedOrigins=["*.churchofjesuschrist.org","*.deserettrust.com","id.churchofjesuschrist.org"];let Origin=null,idpBase="https://id.churchofjesuschrist.org";function sendMessage(e,t){window.top.postMessage(JSON.stringify(e),t)}function allowedDomain(e){let t=getHostName(e),n="*."+getDomain(e),s=allowedOrigins.includes(e),o=allowedOrigins.includes(t),i=allowedOrigins.includes(n);return s||o||i}function handleVisibilityChange(){document.hidden||Origin&&isUserLoggedIn().then(e=>{sendMessage({command:"isUserLoggedIn",reply:e},Origin)})}function processMessage(e){return new Promise((t,n)=>{let s={};try{s=JSON.parse(e)}catch(t){console.debug("Message could not be parsed:",e)}let o={command:s.command,reply:null};switch(s.command){case"ping":o.reply="pong: "+s.payload,t(o);break;case"isUserLoggedIn":case"getCurrentUser":isUserLoggedIn().then(e=>{o.reply=e,t(o)});break;case"userLogout":console.debug("userLogout command received."),userLogout();break;case"activityDetected":console.debug("activityDetected command received.",new Date),throttledKeepSessionAlive();break;default:o.reply="not a defined command",n(o)}})}function getSessionUser(){return new Promise((e,t)=>{fetch(idpBase+"/api/v1/sessions/me",{method:"GET",credentials:"include",mode:"cors"}).then(n=>{200===n.status?n.json().then(t=>{let n=constructCurrentUser(t);e(n)}):t()})})}function getUserProfile(e){return new Promise(t=>{fetch(idpBase+"/api/v1/users/me",{method:"GET",credentials:"include",mode:"cors"}).then(n=>{200===n.status?n.json().then(n=>{getUserToken(e.name,e.userId,n.profile.churchAccountID).then(n=>{e.token=n,t(e)})}):(e.profile=null,e.token=null,t(e))})})}function getUserToken(e,t,n){let s={};return s.name=e,s.id=t,s.altId=n,new Promise((e,t)=>{fetch("/token",{method:"POST",body:JSON.stringify(s),headers:{"Content-Type":"application/json"}}).then(t=>{200===t.status?(console.debug("we should have a token"),t.text().then(t=>{e(t)})):e(void 0)}).catch(function(){e(void 0)})})}function constructCurrentUser(e){return{userId:e.userId,name:e._links.user.name,status:e.status,mfaActive:e.mfaActive,expiresAt:e.expiresAt,createdAt:e.createdAt,loginDurationMillis:Math.abs(new Date(e.createdAt)-new Date),lastPasswordVerification:e.lastPasswordVerification,lastFactorVerification:e.lastFactorVerification}}function constructAnonymousUser(){let e=new Date;return e.setMinutes(e.getMinutes()+30),currentUser={userId:0,name:"anonymous",status:"ANON",expiresAt:e.toISOString()},currentUser}function isUserLoggedIn(e=!1){return new Promise((t,n)=>{let s=localStorage.currentUser,o=getCookie("opinit"),i="true"===getCookie("checkuser");if(!s||e||!o||i)getSessionUser().then(e=>{getUserProfile(e).then(e=>{document.cookie="checkuser=;path=/;domain=churchofjesuschrist.org;expires=Thu, 01 Jan 1970 00:00:01 GMT;",localStorage.currentUser=JSON.stringify(e),document.cookie="opinit=true;",t(e)})},e=>{if(document.cookie="opinit=true;",s){let e=JSON.parse(s);e.status="EXPIRED";let n=new Date;n.setMinutes(n.getMinutes()+30),e.expiresAt=n.toISOString(),localStorage.currentUser=JSON.stringify(e),t(e)}else{let e=constructAnonymousUser();localStorage.currentUser=JSON.stringify(e),t(e)}});else{let e=new Date,n=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()),o=JSON.parse(s),i=Date.parse(o.expiresAt);if(document.cookie="opinit=true;",minsApart(n,i)<5)isUserLoggedIn(!0).then(e=>t(e));else if(i<n){console.debug("USER EXPIRED"),o.status="EXPIRED";let e=new Date;e.setMinutes(e.getMinutes()+30),o.expiresAt=e.toISOString(),localStorage.currentUser=JSON.stringify(o),t(o)}else t(o)}})}function minsApart(e,t){let n=Math.abs(e-t);return Math.floor(n/1e3/60)}function userLogout(){console.debug("called user logout"),localStorage.removeItem("currentUser")}function getHostName(e){let t=e.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!=t&&t.length>2&&"string"==typeof t[2]&&t[2].length>0?t[2]:null}function getDomain(e){let t=getHostName(e),n=t;if(null!=t){let e=t.split(".").reverse();null!=e&&e.length>1&&(n=e[1]+"."+e[0],-1!==t.toLowerCase().indexOf(".co.uk")&&e.length>2&&(n=e[2]+"."+n))}return n}function getCookie(e){const t=e+"=";let n;return decodeURIComponent(document.cookie).split("; ").forEach(e=>{0===e.indexOf(t)&&(n=e.substring(t.length))}),n}function simpleThrottle(e,t){let n=-1;return function(){let s=Date.now();return s>n?(n=s+t,e.apply(null,arguments)):void 0}}function keepSessionAlive(){isUserSessionExpiring()?extendSession().then(e=>updateExpiresAt(e.expiresAt)):console.debug("IDP Session not within expiration window.  Extending session won't be attempted.")}window.addEventListener("message",function(e){allowedDomain(e.origin)?processMessage(e.data).then(t=>{Origin=e.origin,sendMessage(t,e.origin)}).catch(()=>{}):console.debug("NO access from "+e.origin)}),document.addEventListener("visibilitychange",handleVisibilityChange,!1);const DELAY=6e4,throttledKeepSessionAlive=simpleThrottle(keepSessionAlive,6e4);function userSessionTimeRemaining(e){return Date.parse(e.expiresAt)-Date.now()}function isUserSessionExpiring(){let e=!1,t=localStorage.currentUser;if(t){let n=JSON.parse(t);if(n&&"ACTIVE"===n.status){console.debug("localStorage.user.status === 'ACTIVE'"),console.debug(`ExpiresAt: ${n.expiresAt} now: ${new Date}`);const t=18e5;userSessionTimeRemaining(n)<t&&(e=!0)}}return e}function extendSession(){return console.debug("In op.js - extendSession()"),new Promise((e,t)=>{fetch(idpBase+"/api/v1/sessions/me/lifecycle/refresh",{method:"POST",credentials:"include",mode:"cors"}).then(n=>{200===n.status?n.json().then(t=>{console.debug("lifecycle/refresh succeeded - user: "+JSON.stringify(t)),e(t)}):t()})})}function updateExpiresAt(e){let t=localStorage.currentUser;if(t){let n=JSON.parse(t);n&&(console.debug("Setting expiresAt to: "+e),n.expiresAt=e,localStorage.currentUser=JSON.stringify(n))}}
